<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Travel Planner">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="google-adsense-account" content="ca-pub-8025151941140662">
    <title>AI Travel Planner </title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Tajawal:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles-enhanced.css">
    <link rel="stylesheet" href="styles-enhanced-glow.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <!-- Enhanced Background Animation Elements -->
    <div class="grid-pattern"></div>
    <div class="floating-orbs">
        <div class="orb"></div>
        <div class="orb"></div>
        <div class="orb"></div>
    </div>
    <div class="particles" id="particles"></div>
    
    <!-- New Glow Effects -->
    <div class="glow-rings">
        <div class="glow-ring"></div>
        <div class="glow-ring"></div>
        <div class="glow-ring"></div>
        <div class="glow-ring"></div>
    </div>
    
    <div class="glow-orbs">
        <div class="glow-orb"></div>
        <div class="glow-orb"></div>
        <div class="glow-orb"></div>
        <div class="glow-orb"></div>
    </div>
    
    <div class="light-beams">
        <div class="light-beam"></div>
        <div class="light-beam"></div>
        <div class="light-beam"></div>
    </div>
    
    <div class="glow-dots">
        <div class="glow-dot"></div>
        <div class="glow-dot"></div>
        <div class="glow-dot"></div>
        <div class="glow-dot"></div>
        <div class="glow-dot"></div>
    </div>




    <div class="container">
        <div class="header">
            <h1 class="title">
                 AI Travel Planner
                <span class="version-badge">Enhanced</span>
            </h1>
            <div class="header-controls">
                <div id="auth-controls" class="auth-controls">
                    <span id="auth-user" class="auth-user" style="display:none"></span>
                    <a id="login-btn" class="button secondary" href="/auth" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Log in">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                    <button id="logout-btn" class="button secondary" onclick="logout()" style="display:none" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" data-en="Log out">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
                <button class="lang-toggle" onclick="toggleLanguage()" title="Switch Language">
                    <span class="lang-text">English</span>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <button class="ai-assistant-toggle" onclick="toggleAIAssistant()" title="AI Assistant">
                    ğŸ¤–
                </button>
            </div>
        </div>
        
        <!-- Feature Navigation Tabs -->
        <div class="feature-tabs">
            <button class="tab-button active" onclick="showTab('welcome')" data-ar="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" data-en="Home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button class="tab-button" onclick="showTab('planning')" data-ar="Ø§Ù„ØªØ®Ø·ÙŠØ·" data-en="Planning">Ø§Ù„ØªØ®Ø·ÙŠØ·</button>
            <button class="tab-button" onclick="showTab('plans')" data-ar="Ø®Ø·Ø·ÙŠ" data-en="My Plans">Ø®Ø·Ø·ÙŠ</button>
            <button class="tab-button" onclick="showTab('photos')" data-ar="Ø§Ù„ØµÙˆØ±" data-en="Photos">Ø§Ù„ØµÙˆØ±</button>
        </div>

        <div class="grid">
            <!-- Welcome Tab -->
            <div id="welcome-tab" class="tab-content active">
                <div class="panel">
                        <div class="welcome-message">
                            <h3 data-ar="Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø®Ø·Ø· Ø§Ù„Ø³ÙØ± Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!" data-en="Welcome to AI Travel Planner!">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø®Ø·Ø· Ø§Ù„Ø³ÙØ± Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!</h3>
                        <p data-ar="Ø§ÙƒØªØ´Ù ÙˆØ¬Ù‡Ø§Øª Ø±Ø§Ø¦Ø¹Ø© ÙˆØ§Ø³ØªÙƒØ´Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©" data-en="Discover amazing destinations and explore beautiful photos">Ø§ÙƒØªØ´Ù ÙˆØ¬Ù‡Ø§Øª Ø±Ø§Ø¦Ø¹Ø© ÙˆØ§Ø³ØªÙƒØ´Ù Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©</p>
                    </div>
                </div>
            </div>

            <!-- Planning Tab -->
            <div id="planning-tab" class="tab-content">
                <div class="panel">
                    <h2 class="panel-title" data-ar="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©" data-en="Trip Details">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
                    <form id="plan-form" onsubmit="createOrLoadPlan(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" data-ar="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" data-en="Start Date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
                                <input type="date" id="plan-start" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-ar="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©" data-en="End Date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</label>
                                <input type="date" id="plan-end" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group flex-2">
                                <label class="form-label" data-ar="Ø§Ù„ÙˆØ¬Ù‡Ø©" data-en="Destination">Ø§Ù„ÙˆØ¬Ù‡Ø©</label>
                                <input type="text" id="plan-destination" class="form-input" data-ar-placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø±ÙŠØ³ØŒ ÙØ±Ù†Ø³Ø§" data-en-placeholder="Example: Paris, France" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø§Ø±ÙŠØ³ØŒ ÙØ±Ù†Ø³Ø§" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-ar="Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª / Ø§Ù„ÙˆØµÙ" data-en="Interests / Description">Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª / Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="plan-interests" class="form-input" rows="3" data-ar-placeholder="Ø§ÙƒØªØ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ÙˆØªØ¹Ù„ÙŠÙ…Ø§ØªÙƒ (Ù…Ø«Ø§Ù„: Ù…ØªØ§Ø­ÙØŒ Ø¬ÙˆÙ„Ø§Øª Ø·Ø¹Ø§Ù…)" data-en-placeholder="Write your interests/instructions (e.g., museums, food tours)" placeholder="Ø§ÙƒØªØ¨ Ø§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙƒ ÙˆØªØ¹Ù„ÙŠÙ…Ø§ØªÙƒ (Ù…Ø«Ø§Ù„: Ù…ØªØ§Ø­ÙØŒ Ø¬ÙˆÙ„Ø§Øª Ø·Ø¹Ø§Ù…)"></textarea>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="button primary" data-ar="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø·Ø©" data-en="Start Plan">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø®Ø·Ø©</button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title" data-ar="Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©" data-en="Conversation">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                        <div class="panel-actions">
                            <button class="action-btn" title="History" onclick="showVersions()">ğŸ•˜</button>
                        </div>
                    </div>
                    <div id="planner-chat" class="assistant-chat" style="max-height: 420px;"></div>
                    <div class="assistant-input">
                        <input type="text" id="planner-input" class="form-input" data-ar-placeholder="Ø§ÙƒØªØ¨ Ø£Ù…Ø±Ø§Ù‹ Ù…Ø«Ù„: Ø£Ø¶Ù Ø¬ÙˆÙ„Ø© Ù†Ø¨ÙŠØ° ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«" data-en-placeholder="Type a command, e.g., Add a wine tour on day 3" placeholder="Ø§ÙƒØªØ¨ Ø£Ù…Ø±Ø§Ù‹ Ù…Ø«Ù„: Ø£Ø¶Ù Ø¬ÙˆÙ„Ø© Ù†Ø¨ÙŠØ° ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ù„Ø«" onkeypress="plannerKeypress(event)">
                        <button class="button primary" onclick="sendPlannerMessage()" data-ar="Ø¥Ø±Ø³Ø§Ù„" data-en="Send">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title" data-ar="Ø®Ø·Ø© Ø§Ù„Ø±Ø­Ù„Ø©" data-en="Travel Plan">Ø®Ø·Ø© Ø§Ù„Ø±Ø­Ù„Ø©</h2>
                    </div>
                    <div id="plan-view" class="itinerary-container"></div>
                </div>
            </div>

            <!-- Plans (My Plans) Tab -->
            <div id="plans-tab" class="tab-content">
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title" data-ar="Ø®Ø·Ø·ÙŠ" data-en="My Plans">Ø®Ø·Ø·ÙŠ</h2>
                        <div class="panel-actions">
                            <button class="action-btn" onclick="loadPlans()" title="Refresh">ğŸ”„</button>
                        </div>
                    </div>
                    <div id="plans-list" class="itins-list"></div>
                </div>
            </div>

            <!-- Photos Tab -->
            <div id="photos-tab" class="tab-content">
                <div class="panel">
                    <h2 class="panel-title" data-ar="ØµÙˆØ± Ø§Ù„ÙˆØ¬Ù‡Ø©" data-en="Destination Photos">ØµÙˆØ± Ø§Ù„ÙˆØ¬Ù‡Ø©</h2>
                    <div class="photos-input">
                        <input type="text" id="photosDestination" class="form-input" data-ar-placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ù‡Ø©" data-en-placeholder="Enter destination name" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ¬Ù‡Ø©">
                        <button onclick="getPhotos()" class="button primary" data-ar="Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±" data-en="Get Photos">Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±</button>
                    </div>
                    <div id="photos-gallery" class="photos-gallery">
                        <div class="photos-placeholder">
                            <div class="photos-icon">ğŸ“¸</div>
                            <p data-ar="Ø§Ø³ØªÙƒØ´Ù ØµÙˆØ± Ø¬Ù…ÙŠÙ„Ø© Ù„Ù„ÙˆØ¬Ù‡Ø©" data-en="Explore beautiful photos of your destination">Ø§Ø³ØªÙƒØ´Ù ØµÙˆØ± Ø¬Ù…ÙŠÙ„Ø© Ù„Ù„ÙˆØ¬Ù‡Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Travel Assistant -->
        <div id="ai-assistant" class="ai-assistant" style="display: none;">
            <div class="assistant-header">
                <h3 data-ar="Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙØ± Ø§Ù„Ø°ÙƒÙŠ" data-en="AI Travel Assistant">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙØ± Ø§Ù„Ø°ÙƒÙŠ</h3>
                <button class="close-assistant" onclick="toggleAIAssistant()">Ã—</button>
            </div>
            <div class="assistant-chat" id="assistant-chat">
                <div class="assistant-message">
                    <div class="message-content" data-ar="Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø³ÙØ±. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ" data-en="Hello! I'm your AI travel assistant. How can I help you today?">Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø³ÙØ±. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
                </div>
            </div>
            <div class="assistant-input">
                <input type="text" id="assistantInput" class="form-input" data-ar-placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." data-en-placeholder="Type your question here..." placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." onkeypress="handleAssistantKeyPress(event)">
                <button onclick="sendToAssistant()" class="button primary">ğŸ“¤</button>
            </div>
        </div>

       

        <!-- Photo Modal -->
        <div id="photo-modal" class="modal photo-modal" style="display: none;">
            <div class="modal-content photo-modal-content">
                <button class="close-modal" onclick="closePhotoModal()">Ã—</button>
                <img id="modal-photo" src="" alt="Photo">
                <div class="photo-info">
                    <h4 id="modal-photo-title"></h4>
                    <p id="modal-photo-description"></p>
                </div>
            </div>
        </div>

         <!-- Auth Modal
         <div id="auth-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 data-ar="Ø§Ù„Ø­Ø³Ø§Ø¨" data-en="Account">Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                    <button class="close-modal" onclick="closeAuthModal()">Ã—</button>
                </div>
                <div class="modal-body">
                    <div class="auth-tabs">
                        <button id="tab-register" type="button" class="auth-tab active" onclick="setAuthMode('register')" data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨" data-en="Create account">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                        <button id="tab-login" type="button" class="auth-tab" onclick="setAuthMode('login')" data-ar="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„" data-en="Log in">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                    </div>
                    <form id="auth-form" onsubmit="handleAuthSubmit(event)">
                        <div class="form-group">
                            <label class="form-label" data-ar="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-en="Email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="auth-email" class="form-input" required>
                    </div>
                        <div class="form-group">
                            <label class="form-label" data-ar="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-en="Password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="auth-password" class="form-input" required>
                </div>
                        <div class="button-group">
                            <button type="submit" class="button primary" data-ar="Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨" data-en="Create account">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                        </div>
                    </form>
                    <div id="auth-error" class="text-muted" style="color:#e53e3e;margin-top:8px;"></div>
                </div>
            </div>
        </div> -->
        
        <!-- Compact Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                        <a href="https://github.com/Byqb" target="_blank" rel="noopener noreferrer" class="github-link">
                        <svg class="github-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 0C5.374 0 0 5.373 0 12 0 17.302 3.438 21.8 8.207 23.387c.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
                            <span>@Byqb</span>
                        </a>
                    </div>
                <div class="footer-section">
                        <span data-ar="Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©" data-en="Â© 2025 All rights reserved">Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</span>
                    </div>
                </div>
        </footer>
            </div>

    <script>
        // Mobile and Touch Device Detection & Optimization
        const isMobile = window.innerWidth <= 768;
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // Prevent zoom on form inputs (iOS)
        if (isMobile) {
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Add meta viewport dynamically for better control
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport && isTouchDevice) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
            }
            
            // Optimize particle count for mobile
            document.documentElement.style.setProperty('--particle-count', '20');
        }
        
        // Touch gesture improvements
        let touchStartY = 0;
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        }, {passive: true});
        
        document.addEventListener('touchmove', function(e) {
            const touchY = e.touches[0].clientY;
            const touchDiff = touchStartY - touchY;
            
            // Prevent pull-to-refresh on main content
            if (touchDiff < 0 && window.scrollY === 0) {
                e.preventDefault();
            }
        }, {passive: false});
        
        // Mobile AI Assistant optimizations
        function optimizeForMobile() {
            const assistant = document.getElementById('ai-assistant');
            if (assistant && isMobile) {
                // Add mobile-specific classes
                assistant.classList.add('mobile-optimized');
                
                // Improve touch scrolling
                const chat = document.getElementById('assistant-chat');
                if (chat) {
                    chat.style.webkitOverflowScrolling = 'touch';
                    chat.style.overflowScrolling = 'touch';
                }
            }
        }
        
        // PWA Installation Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button if desired
            if (isMobile) {
                console.log('PWA install prompt available');
            }
        });
        
        // Handle app installation
        window.addEventListener('appinstalled', (e) => {
            console.log('PWA was installed');
            deferredPrompt = null;
        });
        
        // Orientation change handling
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                // Recalculate layout after orientation change
                const assistant = document.getElementById('ai-assistant');
                if (assistant && assistant.style.display !== 'none') {
                    // Reposition assistant if needed
                    assistant.style.height = window.innerHeight <= 600 ? '95vh' : '70vh';
                }
            }, 100);
        });

        // Global variables
        let authMode = 'register';
        let currentUser = null;

        // Networking helper with 429-aware retry/backoff
        async function fetchJsonRetry(url, options = {}, retries = 3) {
            let attempt = 0;
            while (true) {
                const res = await fetch(url, options);
                const isJson = (res.headers.get('content-type') || '').includes('application/json');
                if (res.status === 429 && attempt < retries) {
                    const retryAfter = res.headers.get('Retry-After');
                    const delayMs = retryAfter ? Math.ceil(Number(retryAfter) * 1000) : Math.min(10000, Math.round((500 * Math.pow(2, attempt)) + (Math.random() * 250)));
                    await new Promise(r => setTimeout(r, delayMs));
                    attempt++;
                    continue;
                }
                const data = isJson ? await res.json().catch(() => ({})) : {};
                if (!res.ok) {
                    throw new Error((data && data.error && data.error.message) || res.statusText || 'Request failed');
                }
                return data;
            }
        }

        // Enhanced Particle System
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleTypes = ['particle-small', 'particle-medium', 'particle-large', 'particle-glow', 'particle-star'];
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                const randomType = particleTypes[Math.floor(Math.random() * particleTypes.length)];
                particle.className = `particle ${randomType}`;
                
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
                
                const drift = (Math.random() - 0.5) * 100;
                particle.style.setProperty('--drift', drift + 'px');
                
                particlesContainer.appendChild(particle);
            }
        }

        function generateNewParticle() {
            const particlesContainer = document.getElementById('particles');
            const particleTypes = ['particle-small', 'particle-medium', 'particle-large', 'particle-glow', 'particle-star'];
            
            const particle = document.createElement('div');
            const randomType = particleTypes[Math.floor(Math.random() * particleTypes.length)];
            particle.className = `particle ${randomType}`;
            
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
            
            particlesContainer.appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 35000);
        }

        // Initialize particles
        window.addEventListener('load', () => {
            createParticles();
            setInterval(generateNewParticle, 2000);
        });

        // Language and Theme Management
        function setLanguage(lang) {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('language', lang);
            
            const langText = document.querySelector('.lang-text');
            langText.textContent = lang === 'ar' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
            
            document.querySelectorAll('[data-ar]').forEach(element => {
                element.textContent = element.getAttribute(`data-${lang}`);
            });

            document.querySelectorAll('[data-ar-placeholder]').forEach(element => {
                element.placeholder = element.getAttribute(`data-${lang}-placeholder`);
            });

            // Update select options
            document.querySelectorAll('option[data-ar]').forEach(element => {
                element.textContent = element.getAttribute(`data-${lang}`);
            });
        }

        function toggleLanguage() {
            const currentLang = document.documentElement.lang;
            setLanguage(currentLang === 'ar' ? 'en' : 'ar');
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        // Tab Management
    function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Mark button as active
            event.target.classList.add('active');
        }

        // Auth Functions
        function setAuthMode(mode) {
            authMode = mode === 'login' ? 'login' : 'register';
            const submitBtn = document.querySelector('#auth-form .button.primary');
            if (authMode === 'login') {
                submitBtn.setAttribute('data-ar', 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); submitBtn.setAttribute('data-en', 'Log in');
            } else {
                submitBtn.setAttribute('data-ar', 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'); submitBtn.setAttribute('data-en', 'Create account');
            }
            const tabReg = document.getElementById('tab-register');
            const tabLog = document.getElementById('tab-login');
            if (tabReg && tabLog) {
                if (authMode === 'register') {
                    tabReg.classList.add('active');
                    tabLog.classList.remove('active');
                        } else {
                    tabLog.classList.add('active');
                    tabReg.classList.remove('active');
                }
            }
            updateAuthTexts();
        }
        
        // Modal auth is no longer used on home; we redirect to /auth instead
        function openAuthModal() { location.href = '/auth?redirect=' + encodeURIComponent(location.pathname); }
        function openRegisterModal() { location.href = '/auth?redirect=' + encodeURIComponent(location.pathname); }
        function openLoginModal() { location.href = '/auth?redirect=' + encodeURIComponent(location.pathname); }
        function closeAuthModal() {}
        function switchAuthMode() {}
        
        async function handleAuthSubmit(e) { e && e.preventDefault(); }
        
        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            location.replace('/auth');
        }
        
        async function checkAuth() {
            const res = await fetch('/api/auth/me');
                const data = await res.json();
            currentUser = data.user;
            if (currentUser) {
                document.getElementById('auth-user').textContent = currentUser.email;
                document.getElementById('auth-user').style.display = 'inline-block';
                document.getElementById('login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
            } else {
                // Always redirect to auth if not logged in
                if (!location.pathname.startsWith('/auth')) {
                    location.replace('/auth?redirect=' + encodeURIComponent(location.pathname));
                }
            }
        }
        
        function updateAuthTexts() {
            // Re-apply language text for auth controls
            setLanguage(document.documentElement.lang);
        }

		// ===== Planner (Plans + Chat + Rendering) =====
		let currentPlanId = null;

		function appendPlannerChat(role, text, ts) {
			const box = document.getElementById('planner-chat');
			if (!box) return;
			const row = document.createElement('div');
			row.className = role === 'user' ? 'user-message' : 'assistant-message';
			const content = document.createElement('div');
			content.className = 'message-content';
			content.textContent = text;
			row.appendChild(content);
			const meta = document.createElement('div');
			meta.className = 'msg-meta';
			try {
				const d = ts ? new Date(ts) : new Date();
				meta.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
			} catch { meta.textContent = '' }
			row.appendChild(meta);
			box.appendChild(row);
			box.scrollTop = box.scrollHeight;
		}

		function displayItineraryArray(itineraryArray) {
			const container = document.getElementById('plan-view');
			if (!container) return;
			container.innerHTML = '';
			const currentLang = document.documentElement.lang;
			const dayText = currentLang === 'ar' ? 'Ø§Ù„ÙŠÙˆÙ…' : 'Day';
			const labels = currentLang === 'ar' ? { morning: 'ØµØ¨Ø§Ø­Ø§Ù‹', midday: 'Ù…Ù†ØªØµÙ Ø§Ù„ÙŠÙˆÙ…', evening: 'Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙŠÙˆÙ…' } : { morning: 'Morning', midday: 'Midday', evening: 'End of day' };
			(itineraryArray || []).forEach(day => {
				const daySection = document.createElement('div');
				daySection.className = 'day-section';
				const title = document.createElement('h3');
				title.className = 'day-title';
				title.textContent = `${dayText} ${day.day || ''}`;
				daySection.appendChild(title);
				['Morning','Midday','End of day'].forEach(slot => {
					const list = (day.activities || []).filter(a => (a.time || '').toLowerCase() === slot.toLowerCase());
					if (!list.length) return;
					const sub = document.createElement('h4');
					sub.className = 'time-bucket-title';
					sub.textContent = labels[slot.toLowerCase()] || slot;
					daySection.appendChild(sub);
					list.forEach(a => {
						const item = document.createElement('div');
						item.className = 'activity';
						const head = document.createElement('div'); head.className = 'activity-header';
						const t = document.createElement('h5'); t.className = 'activity-title'; t.textContent = a.title || '';
						head.appendChild(t);
						const tm = document.createElement('span'); tm.className = 'activity-time'; tm.textContent = a.time || '';
						head.appendChild(tm);
						item.appendChild(head);
						if (a.description) { const d = document.createElement('p'); d.className = 'activity-description'; d.textContent = a.description; item.appendChild(d); }
						daySection.appendChild(item);
					});
				});
				container.appendChild(daySection);
			});
		}

		async function createOrLoadPlan(event) {
			event.preventDefault();
			const startDate = document.getElementById('plan-start').value;
			const endDate = document.getElementById('plan-end').value;
			const destination = document.getElementById('plan-destination').value.trim();
			const interestsText = document.getElementById('plan-interests').value.trim();
			const preferences = interestsText ? interestsText.split(',').map(s => s.trim()).filter(Boolean) : [];
			if (!startDate || !endDate || !destination) return;
			// Generate initial plan via AI
			const loading = document.createElement('div'); loading.className = 'loading active'; loading.innerHTML = '<div class="spinner"></div>';
			document.getElementById('plan-view').innerHTML = ''; document.getElementById('plan-view').appendChild(loading);
			try {
				const data = await fetchJsonRetry('/api/generate-itinerary', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ startDate, endDate, destination, preferences, language: document.documentElement.lang }) });
				// Create DB record
				const created = await fetchJsonRetry('/api/itineraries', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: destination, destination, startDate, endDate, language: document.documentElement.lang, plan: data }) });
				currentPlanId = created.id;
				// Reset chat and render
				document.getElementById('planner-chat').innerHTML = '';
				appendPlannerChat('assistant', data.reply || (document.documentElement.lang === 'ar' ? 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø·Ø©.' : 'Plan generated.'), new Date().toISOString());
				displayItineraryArray(data.itinerary || []);
			} catch (e) {
				document.getElementById('plan-view').innerHTML = `<div class="error-message">âŒ ${e.message}</div>`;
			}
		}

		function plannerKeypress(event) { if (event.key === 'Enter') sendPlannerMessage(); }

		async function sendPlannerMessage() {
			const input = document.getElementById('planner-input');
			const text = (input.value || '').trim();
			if (!text) return;
			if (!currentPlanId) { appendPlannerChat('assistant', document.documentElement.lang === 'ar' ? 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹.' : 'Start by creating a plan first.'); return; }
			appendPlannerChat('user', text, new Date().toISOString());
			appendPlannerChat('assistant', 'â€¦');
			input.value = '';
			try {
			const data = await fetchJsonRetry(`/api/itineraries/${currentPlanId}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, language: document.documentElement.lang }) });
				const box = document.getElementById('planner-chat');
				if (box && box.lastChild && box.lastChild.classList.contains('assistant-message')) {
					box.lastChild.querySelector('.message-content').textContent = data.reply || 'OK';
					const meta = box.lastChild.querySelector('.msg-meta'); if (meta) meta.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
				}
				if (data.plan && data.plan.itinerary) {
					displayItineraryArray(data.plan.itinerary);
				}
			} catch (e) {
				const box = document.getElementById('planner-chat');
				if (box && box.lastChild && box.lastChild.classList.contains('assistant-message')) {
					box.lastChild.querySelector('.message-content').textContent = 'âŒ ' + e.message;
				}
			}
		}

		async function loadPlans() {
			const list = document.getElementById('plans-list');
			list.innerHTML = '<div class="loading-small">Loadingâ€¦</div>';
			try {
				const res = await fetch('/api/itineraries');
				const data = await res.json();
				const items = Array.isArray(data.itineraries) ? data.itineraries : [];
				if (!items.length) { list.innerHTML = `<div class="text-center text-muted">${document.documentElement.lang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø·' : 'No plans yet'}</div>`; return; }
				list.innerHTML = items.map(it => `
					<div class="itin-row">
						<div>
							<div class="itin-title">${(it.title || it.destination || 'â€”')}</div>
							<div class="itin-sub">${(it.destination || 'â€”')} Â· ${it.startDate || ''} â†’ ${it.endDate || ''}</div>
						</div>
						<div class="itin-actions">
							<button class="action-btn" title="Open" onclick="openPlan('${it.id}')">ğŸ“‚</button>
							<button class="action-btn" title="Rename" onclick="renamePlan('${it.id}')">âœï¸</button>
							<button class="action-btn" title="Delete" onclick="deletePlan('${it.id}')">ğŸ—‘ï¸</button>
						</div>
					</div>
				`).join('');
			} catch (e) {
				list.innerHTML = `<div class="error-message">âŒ ${e.message}</div>`;
			}
		}

		async function openPlan(id) {
			try {
				const res = await fetch(`/api/itineraries/${id}`);
				const data = await res.json();
				if (!res.ok) throw new Error(data.error?.message || 'Failed');
				currentPlanId = id;
				document.querySelector('.tab-button[onclick*="planning"]').click();
				const chatBox = document.getElementById('planner-chat'); chatBox.innerHTML = '';
				(data.messages || []).forEach(m => appendPlannerChat(m.role === 'user' ? 'user' : 'assistant', m.content));
				if (data.itinerary && data.itinerary.plan && data.itinerary.plan.itinerary) {
					displayItineraryArray(data.itinerary.plan.itinerary);
				} else {
					document.getElementById('plan-view').innerHTML = '';
				}
			} catch (e) {
				alert(e.message);
			}
		}

		async function renamePlan(id) {
			const title = prompt(document.documentElement.lang === 'ar' ? 'Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø®Ø·Ø©:' : 'New plan title:');
			if (!title) return;
			try {
				const res = await fetch(`/api/itineraries/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title }) });
				if (!res.ok) { const d = await res.json(); throw new Error(d.error?.message || 'Failed'); }
				loadPlans();
			} catch (e) { alert(e.message); }
		}

		async function deletePlan(id) {
			if (!confirm(document.documentElement.lang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ø®Ø·Ø©ØŸ' : 'Delete plan?')) return;
			try {
				const res = await fetch(`/api/itineraries/${id}`, { method: 'DELETE' });
				if (!res.ok) { const d = await res.json(); throw new Error(d.error?.message || 'Failed'); }
				if (currentPlanId === id) { currentPlanId = null; document.getElementById('planner-chat').innerHTML = ''; document.getElementById('plan-view').innerHTML = ''; }
				loadPlans();
			} catch (e) { alert(e.message); }
		}

		async function showVersions() {
			if (!currentPlanId) return;
			try {
				const res = await fetch(`/api/itineraries/${currentPlanId}/versions`);
				const data = await res.json();
				if (!res.ok) throw new Error(data.error?.message || 'Failed');
				const lines = (data.versions || []).map(v => `${document.documentElement.lang === 'ar' ? 'Ø¥ØµØ¯Ø§Ø±' : 'Version'} ${v.version} â€“ ${new Date(v.createdAt).toLocaleString()}`);
				alert(lines.join('\n') || (document.documentElement.lang === 'ar' ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯' : 'No versions yet'));
			} catch (e) { alert(e.message); }
		}

        // Photos Functions
        async function getPhotos() {
            const destination = document.getElementById('photosDestination').value;
            if (!destination) return;
            
            const gallery = document.getElementById('photos-gallery');
            gallery.innerHTML = '<div class="loading-small">Loading photos...</div>';
            
            try {
                const data = await fetchJsonRetry(`/api/photos/${encodeURIComponent(destination)}`);
                
                gallery.innerHTML = `
                    <div class="photos-grid">
                        ${data.photos.map(photo => `
                            <div class="photo-item" onclick="openPhotoModal('${photo.url}', '${photo.description}', '${photo.photographer}')">
                                <img src="${photo.thumbnail}" alt="${photo.description}" loading="lazy">
                                <div class="photo-overlay">
                                    <span class="photo-title">${photo.description}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                gallery.innerHTML = `<div class="error-message">âŒ ${error.message}</div>`;
            }
        }

        function openPhotoModal(url, description, photographer) {
            document.getElementById('modal-photo').src = url;
            document.getElementById('modal-photo-title').textContent = description;
            document.getElementById('modal-photo-description').textContent = `Photo by ${photographer}`;
            document.getElementById('photo-modal').style.display = 'flex';
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').style.display = 'none';
        }

        // AI Assistant Functions
        function toggleAIAssistant() {
            const assistant = document.getElementById('ai-assistant');
            assistant.style.display = assistant.style.display === 'none' ? 'flex' : 'none';
        }

        function handleAssistantKeyPress(event) {
            if (event.key === 'Enter') {
                sendToAssistant();
            }
        }

        // Helper function to format markdown-like text
        function formatMarkdown(text) {
            if (!text) return '';
            
            return text
                // Bold text **text** -> <strong>text</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic text *text* -> <em>text</em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Headers ### text -> <h3>text</h3>
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                // Lists - item -> <li>item</li>
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                // Code blocks `code` -> <code>code</code>
                .replace(/`(.*?)`/g, '<code>$1</code>')
                // Line breaks
                .replace(/\n/g, '<br>')
                // Wrap list items in ul tags
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                // Fix multiple ul tags
                .replace(/<\/ul>\s*<ul>/g, '');
        }

        async function sendToAssistant() {
            const input = document.getElementById('assistantInput');
            const message = input.value.trim();
            if (!message) return;
            
            const chat = document.getElementById('assistant-chat');
            
            // Add user message
            chat.innerHTML += `
                <div class="user-message">
                    <div class="message-content">${message}</div>
                </div>
            `;
            
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            
            // Show typing indicator
            const typingIndicator = `
                <div class="assistant-message typing" id="typing-indicator">
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chat.innerHTML += typingIndicator;
            chat.scrollTop = chat.scrollHeight;
            
            try {
                const data = await fetchJsonRetry('/api/ai-assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        language: document.documentElement.lang
                    })
                });
                
                // Remove typing indicator
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) typingElement.remove();
                
                // Format and add assistant response with markdown support
                const formattedResponse = formatMarkdown(data.response);
                const providerBadge = data.provider ? `<span class="provider-badge">${data.provider === 'huggingface' ? 'ğŸ¤— HF' : 'ğŸš€ OR'}</span>` : '';
                
                chat.innerHTML += `
                    <div class="assistant-message">
                        <div class="message-content">${formattedResponse}</div>
                        ${providerBadge}
                    </div>
                `;
            } catch (error) {
                // Remove typing indicator
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) typingElement.remove();
                
                chat.innerHTML += `
                    <div class="assistant-message error">
                        <div class="message-content">âŒ ${error.message}</div>
                    </div>
                `;
            }
            
            chat.scrollTop = chat.scrollHeight;
        }

        // Initialize
        const savedLang = localStorage.getItem('language') || 'ar';
        setLanguage(savedLang);

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);
        checkAuth();
    </script>
</body>
</html>
